# -*- coding: utf-8 -*-
"""Working Budget

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1t7ITyihqEuZ5Cgsp6JTZv_EK5pDlq2rj
"""

from dash import Dash, html, dcc, Input, Output, State

app = Dash(__name__)

# Inject custom CSS for mobile responsiveness
app.index_string = '''
<!DOCTYPE html>
<html>
    <head>
        {%metas%}
        <title>{%title%}</title>
        {%favicon%}
        {%css%}
        <style>
            @media (max-width: 768px) {
                .two-column-grid {
                    grid-template-columns: 1fr !important;
                }
                .budget-overview-grid {
                    grid-template-columns: 1fr !important;
                }
                .header-title {
                    font-size: 32px !important;
                }
                .header-subtitle {
                    font-size: 16px !important;
                }
                .reset-button-mobile {
                    position: static !important;
                    display: block !important;
                    margin: 15px auto 0 auto !important;
                }
                .section-padding {
                    padding: 20px 15px !important;
                }
                .card-padding {
                    padding: 20px !important;
                }
                .banner-padding {
                    padding: 20px 15px !important;
                }
                .main-container {
                    padding: 20px 15px !important;
                }
                .balance-banner-mobile {
                    font-size: 32px !important;
                }
                .balance-icon-mobile {
                    font-size: 28px !important;
                }
            }
        </style>
    </head>
    <body>
        {%app_entry%}
        <footer>
            {%config%}
            {%scripts%}
            {%renderer%}
        </footer>
    </body>
</html>
'''

# Budget data (in millions) - FY26 Actual
TOTAL_BUDGET = 4630  # FY26: $4,629,782,075
OPERATING_BUDGET = 3698  # FY26: $3,697,794,789
CAPITAL_BUDGET = 932  # FY26: $931,987,286
GENERAL_FUND = 2450  # General Fund (subset of operating)

# Property tax data
CURRENT_PROPERTY_TAX_RATE = 2.25  # per $100 assessed value
PROPERTY_TAX_REVENUE = 1200.3  # in millions

# Income tax data
CURRENT_INCOME_TAX_RATE = 3.2  # percent
INCOME_TAX_REVENUE = 499.593  # in millions
MAX_INCOME_TAX_RATE = 3.3  # state law cap

# Energy tax data
CURRENT_ENERGY_TAX_REVENUE = 51.8  # in millions - FY26 budget projection
ENERGY_TAX_MIN_PERCENT = -20  # allow 20% decrease
ENERGY_TAX_MAX_PERCENT = 20  # allow 20% increase

# Homestead credit data
CURRENT_HOMESTEAD_CAP = 4.0  # percent - current Baltimore City cap
MAX_HOMESTEAD_CAP = 10.0  # percent - state maximum
HOMESTEAD_COST_AT_4PCT = 23.2  # millions - current cost to city
HOMESTEAD_COST_AT_10PCT = 5.4  # millions - cost if raised to 10%

# Targeted Homeowners Tax Credit data
TARGETED_HOMEOWNERS_CREDIT_COST = 32.0  # millions - FY26 budget (using higher estimate)

# Policy reform data
CHILDREN_PER_AGE = 7.0  # 7,000 children per age (124k total / ~18 ages, rounded)
BIKE_LANES_COST_PER_MILE = 0.15  # $150k per mile
VACANT_HOME_REHAB_COST_PER_HOME = 0.15  # $150k per home
TOTAL_VACANT_HOMES = 1200  # Total vacant homes in Baltimore
CITY_OWNED_VACANT_HOMES = 1000  # Vacant homes owned by the city
WATER_TAXI_FREE_YEAR_ROUND = 4  # $4M - make water taxi free year-round and run 7 days/week
WATER_TAXI_ADDITIONAL_ROUTE = 1  # $1M - add an additional water taxi route
BABIES_PER_YEAR = 7500  # Roughly 7,500 babies born per year in Baltimore
PUBLIC_HOUSING_COST_PER_UNIT = 0.3  # $300k per unit
# Transit improvements
CIRCULATOR_ROUTE_BASE_COST = 2.5  # $2.5M per route per year (normal headways)
CIRCULATOR_ROUTE_REDUCED_HEADWAY_COST = 5.0  # $5M per route per year (50% reduced headways - doubles cost)
CIRCULATOR_EXISTING_ROUTES = 4  # Current number of routes
CIRCULATOR_HEADWAY_REDUCTION_EXISTING_COST = 10.0  # $10M to reduce headways on existing 4 routes
BUS_LANES_COST_PER_MILE = 0.3  # $300k per mile

# Meds & Eds revenue data
MEDS_EDS_FULL_PROPERTY_TAX = 108.0  # $108M - full property tax if they paid like everyone else
MEDS_EDS_SERVICES_COST = 47.7  # $47.7M - annual cost of city services they use
MEDS_EDS_CURRENT_PILOT = 6.0  # $6M - current PILOT payment (ramping to $12M by 2030)

# Agency spending data (FY26 General Fund Appropriation in millions)
# General Fund = where city officials have large discretion over how funds are used
agencies = {
    'Equity and Civil Rights': 6.0,
    'Finance': 35.0,
    'Fire': 339.0,
    'General Services': 15.0,
    'Health': 55.6,
    'Human Resources': 12.6,
    'Law': 14.7,
    'Legislative References': 2.4,
    'Housing and Community Development': 54.8,
    'Police': 566.6,
    'Planning': 8.5,
    'Public Works': 136.1,
    'Recreation and Parks': 61.3,
    'Transportation': 157.4
}

# Agency information tooltips
agency_info = {
    'Equity and Civil Rights': 'Enforces anti-discrimination laws, investigates civil rights complaints, and promotes equity initiatives across city programs.',
    'Finance': 'Manages city finances, payroll, tax collection, purchasing, and financial reporting.',
    'Fire': 'Operates 37 fire stations responding to over 200,000 calls annually including fires, EMS, and rescues.',
    'General Services': 'Maintains city buildings and facilities, manages vehicle fleet, provides building security, and handles repairs.',
    'Health': 'Provides disease prevention, environmental health inspections, substance abuse programs, and maternal/child health services.',
    'Human Resources': 'Manages employee hiring, benefits, training, labor relations, and workforce development programs.',
    'Law': 'Serves as city legal department, representing Baltimore in lawsuits and providing legal advice to agencies.',
    'Legislative References': 'Provides research, bill drafting, and administrative support to the Baltimore City Council.',
    'Housing and Community Development': 'Manages affordable housing, community development, code enforcement, and vacant property programs.',
    'Police': 'Provides law enforcement services citywide. Budget includes federal consent decree costs. Represents ~26% of General Fund.',
    'Planning': 'Develops zoning regulations, reviews development projects, and creates long-range city plans.',
    'Public Works': 'General Fund supports streets, trash collection, and administration. DPW also operates large enterprise funds (water/sewer) funded by user fees that cannot be redirected. Total budget: $774.7M (GF: $136.1M).',
    'Recreation and Parks': 'Maintains parks, recreation centers, playgrounds, and public spaces; provides recreational programs.',
    'Transportation': 'Manages streets, bridges, sidewalks, traffic signals, street lighting, and coordinates transit initiatives.',
}

# Critical services that should be highlighted when cut
CRITICAL_SERVICES = ['Fire', 'Police', 'Health', 'Public Works']

# MDIPP Colors
MDIPP_MAROON = '#9D2235'
MDIPP_ORANGE = '#E8743B'
MDIPP_LIGHT_GRAY = '#F5F5F5'
MDIPP_DARK_GRAY = '#333333'

def format_currency(amount_in_millions):
    """Format currency, switching to billions when >= 1000M"""
    if abs(amount_in_millions) >= 1000:
        return f'${amount_in_millions/1000:.2f}B'
    else:
        return f'${amount_in_millions:.1f}M'

app.layout = html.Div(style={'fontFamily': 'Georgia, serif', 'padding': '0', 'backgroundColor': MDIPP_LIGHT_GRAY, 'minHeight': '100vh'}, children=[

    # Location component for URL management
    dcc.Location(id='url', refresh=False),

    # Store to hold initial values from URL (loaded once)
    dcc.Store(id='initial-values-store', data=None),

    # Header
    html.Div(className='section-padding', style={'backgroundColor': MDIPP_MAROON, 'padding': '40px 20px', 'color': 'white', 'position': 'relative'}, children=[
        html.H1('Baltimore Budget Project', className='header-title', style={'margin': '0', 'textAlign': 'center', 'fontWeight': '700', 'fontSize': '48px', 'letterSpacing': '-1px'}),
        html.P('FY2026 Budget Simulator', className='header-subtitle', style={'textAlign': 'center', 'fontSize': '20px', 'margin': '10px 0 0 0', 'fontWeight': '300'}),

        # Reset button - positioned in top right on desktop, centered below on mobile
        html.Button('Reset All',
                   id='reset-button',
                   n_clicks=0,
                   className='reset-button-mobile',
                   style={
                       'position': 'absolute',
                       'top': '20px',
                       'right': '20px',
                       'padding': '10px 20px',
                       'backgroundColor': 'rgba(255, 255, 255, 0.2)',
                       'color': 'white',
                       'border': '1px solid rgba(255, 255, 255, 0.4)',
                       'borderRadius': '4px',
                       'cursor': 'pointer',
                       'fontSize': '14px',
                       'fontWeight': '500',
                       'transition': 'all 0.2s',
                   }),
    ]),

    # Net Budget Balance Banner
    html.Div(className='banner-padding', style={'backgroundColor': 'white', 'padding': '30px 20px', 'borderBottom': f'4px solid {MDIPP_ORANGE}'}, children=[
        html.Div(id='net-balance-banner', style={'textAlign': 'center', 'maxWidth': '1200px', 'margin': '0 auto'})
    ]),

    # Share Link Section
    html.Div(className='banner-padding', style={'backgroundColor': MDIPP_LIGHT_GRAY, 'padding': '20px', 'borderBottom': '2px solid #E8E8E8'}, children=[
        html.Div(style={'textAlign': 'center', 'maxWidth': '1200px', 'margin': '0 auto'}, children=[
            html.Button('üìã Generate Share Link',
                       id='generate-link-button',
                       n_clicks=0,
                       style={
                           'padding': '12px 24px',
                           'backgroundColor': MDIPP_ORANGE,
                           'color': 'white',
                           'border': 'none',
                           'borderRadius': '4px',
                           'cursor': 'pointer',
                           'fontSize': '16px',
                           'fontWeight': '600',
                           'transition': 'all 0.2s',
                           'boxShadow': '0 2px 4px rgba(0,0,0,0.1)'
                       }),
            html.Div(id='share-link-display', style={'marginTop': '15px'})
        ])
    ]),

    # Main Content Container
    html.Div(className='main-container', style={'maxWidth': '1600px', 'margin': '0 auto', 'padding': '30px 15px'}, children=[

        # How to Use Section (Collapsible)
        html.Div(className='card-padding', style={'backgroundColor': 'white', 'padding': '30px', 'borderRadius': '2px', 'marginBottom': '30px', 'boxShadow': '0 2px 8px rgba(0,0,0,0.1)', 'borderTop': f'4px solid {MDIPP_ORANGE}'}, children=[
            html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '15px', 'cursor': 'pointer'}, id='how-to-use-header', children=[
                html.H2('How to Use This Simulator', style={'color': MDIPP_MAROON, 'marginBottom': '0', 'fontSize': '28px', 'fontWeight': '600', 'marginRight': '12px'}),
                html.Div('‚ñº', id='how-to-use-toggle-icon', style={'fontSize': '18px', 'color': MDIPP_ORANGE, 'transition': 'transform 0.3s'}),
            ]),
            html.Div(id='how-to-use-content', style={'display': 'none'}, children=[
                html.P([
                    'This tool lets you explore Baltimore City\'s FY26 budget by adjusting revenue sources and spending priorities. ',
                    'Use the sliders on the left to change tax rates (property, income, energy) and the sliders on the right to adjust agency budgets. ',
                    'Explore additional policy reforms at the bottom. ',
                    'Your changes are calculated in real-time, and the banner at the top shows whether your budget is balanced, in surplus, or in deficit.'
                ], style={'margin': '0 0 15px 0', 'fontSize': '16px', 'lineHeight': '1.6', 'color': MDIPP_DARK_GRAY}),
                html.P([
                    'You can share your budget by clicking the "Generate Share Link" button‚Äîall your changes are saved in the link. ',
                    'Hover over agency names to see what they do, and watch for warnings when cutting critical services like Fire, Police, or Health.'
                ], style={'margin': '0 0 15px 0', 'fontSize': '16px', 'lineHeight': '1.6', 'color': MDIPP_DARK_GRAY}),
                html.Div(style={'padding': '15px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'4px solid {MDIPP_ORANGE}', 'marginTop': '20px'}, children=[
                    html.P([
                        html.Strong('Future Development: '),
                        'This is a simplified simulator based on high-level FY26 categories. Our goal is to create a much more detailed version for FY27 with more granular budget breakdowns once we acquire detailed agency budgets from Baltimore City.'
                    ], style={'margin': '0', 'fontSize': '14px', 'fontStyle': 'italic', 'color': '#666'})
                ])
            ])
        ]),

        # Budget Overview
        html.Div(className='card-padding', style={'backgroundColor': 'white', 'padding': '30px', 'borderRadius': '2px', 'marginBottom': '30px', 'boxShadow': '0 2px 8px rgba(0,0,0,0.1)', 'borderTop': f'4px solid {MDIPP_MAROON}'}, children=[
            html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '15px'}, children=[
                html.H2('Budget Overview', style={'color': MDIPP_MAROON, 'marginBottom': '0', 'fontSize': '28px', 'fontWeight': '600', 'marginRight': '12px'}),
                html.Div(
                    '‚Ñπ',
                    id='budget-overview-info-icon',
                    style={
                        'cursor': 'help',
                        'fontSize': '18px',
                        'fontWeight': 'bold',
                        'color': 'white',
                        'backgroundColor': MDIPP_ORANGE,
                        'borderRadius': '50%',
                        'width': '24px',
                        'height': '24px',
                        'display': 'inline-flex',
                        'alignItems': 'center',
                        'justifyContent': 'center',
                        'fontFamily': 'Arial, sans-serif',
                        'fontStyle': 'normal',
                    },
                    title='Click to learn more about Baltimore\'s budget'
                ),
            ]),
            html.Div(id='budget-overview-explanation', style={'display': 'none', 'marginBottom': '20px', 'padding': '15px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                html.P([
                    html.Strong('Total Budget ($4.63B): '),
                    html.Span('All city spending including operating expenses and capital projects.')
                ], style={'margin': '8px 0', 'fontSize': '14px'}),
                html.P([
                    html.Strong('Operating Budget ($3.70B): '),
                    html.Span('Day-to-day expenses like salaries, programs, services, and supplies.')
                ], style={'margin': '8px 0', 'fontSize': '14px'}),
                html.P([
                    html.Strong('Capital Budget ($932M): '),
                    html.Span('Long-term investments in infrastructure, construction, and major facility improvements.')
                ], style={'margin': '8px 0', 'fontSize': '14px'}),
                html.P([
                    html.Strong('General Fund ($2.45B): '),
                    html.Span('This simulator focuses on the General Fund - the portion where city officials have the most discretion. About $950M of the General Fund is "fixed costs" (pension, debt service, BCPS contribution) that cannot be easily changed in the short-term. City officials have large discretion over the remaining $1.5B, which is predominately allocated to the 14 city agencies.')
                ], style={'margin': '8px 0', 'fontSize': '14px'}),
            ]),
            html.Div(className='budget-overview-grid', style={'display': 'grid', 'gridTemplateColumns': 'repeat(auto-fit, minmax(220px, 1fr))', 'gap': '20px'}, children=[
                html.Div(style={'padding': '20px', 'backgroundColor': MDIPP_LIGHT_GRAY, 'borderRadius': '2px', 'borderLeft': f'4px solid {MDIPP_MAROON}'}, children=[
                    html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '8px'}, children=[
                        html.Div('Total Budget', style={'fontSize': '14px', 'color': '#666', 'textTransform': 'uppercase', 'letterSpacing': '0.5px', 'marginRight': '8px'}),
                        html.Div(
                            '‚Ñπ',
                            style={
                                'cursor': 'help',
                                'fontSize': '12px',
                                'fontWeight': 'bold',
                                'color': 'white',
                                'backgroundColor': '#888',
                                'borderRadius': '50%',
                                'width': '16px',
                                'height': '16px',
                                'display': 'inline-flex',
                                'alignItems': 'center',
                                'justifyContent': 'center',
                                'fontFamily': 'Arial, sans-serif',
                            },
                            title='The complete city budget including operating and capital expenses across all funding sources.'
                        ),
                    ]),
                    html.Div(format_currency(TOTAL_BUDGET), style={'fontSize': '28px', 'fontWeight': 'bold', 'color': MDIPP_MAROON}),
                ]),
                html.Div(style={'padding': '20px', 'backgroundColor': MDIPP_LIGHT_GRAY, 'borderRadius': '2px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                    html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '8px'}, children=[
                        html.Div('Operating Budget', style={'fontSize': '14px', 'color': '#666', 'textTransform': 'uppercase', 'letterSpacing': '0.5px', 'marginRight': '8px'}),
                        html.Div(
                            '‚Ñπ',
                            style={
                                'cursor': 'help',
                                'fontSize': '12px',
                                'fontWeight': 'bold',
                                'color': 'white',
                                'backgroundColor': '#888',
                                'borderRadius': '50%',
                                'width': '16px',
                                'height': '16px',
                                'display': 'inline-flex',
                                'alignItems': 'center',
                                'justifyContent': 'center',
                                'fontFamily': 'Arial, sans-serif',
                            },
                            title='Day-to-day expenses: salaries, programs, services, and supplies that keep the city running.'
                        ),
                    ]),
                    html.Div(format_currency(OPERATING_BUDGET), style={'fontSize': '28px', 'fontWeight': 'bold', 'color': MDIPP_MAROON}),
                ]),
                html.Div(style={'padding': '20px', 'backgroundColor': MDIPP_LIGHT_GRAY, 'borderRadius': '2px', 'borderLeft': f'4px solid {MDIPP_MAROON}'}, children=[
                    html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '8px'}, children=[
                        html.Div('Capital Budget', style={'fontSize': '14px', 'color': '#666', 'textTransform': 'uppercase', 'letterSpacing': '0.5px', 'marginRight': '8px'}),
                        html.Div(
                            '‚Ñπ',
                            style={
                                'cursor': 'help',
                                'fontSize': '12px',
                                'fontWeight': 'bold',
                                'color': 'white',
                                'backgroundColor': '#888',
                                'borderRadius': '50%',
                                'width': '16px',
                                'height': '16px',
                                'display': 'inline-flex',
                                'alignItems': 'center',
                                'justifyContent': 'center',
                                'fontFamily': 'Arial, sans-serif',
                            },
                            title='Long-term infrastructure projects: construction, major renovations, and facility improvements.'
                        ),
                    ]),
                    html.Div(f'${CAPITAL_BUDGET:,.0f}M', style={'fontSize': '28px', 'fontWeight': 'bold', 'color': MDIPP_MAROON}),
                ]),
                html.Div(style={'padding': '20px', 'backgroundColor': MDIPP_LIGHT_GRAY, 'borderRadius': '2px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                    html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '8px'}, children=[
                        html.Div('General Fund', style={'fontSize': '14px', 'color': '#666', 'textTransform': 'uppercase', 'letterSpacing': '0.5px', 'marginRight': '8px'}),
                        html.Div(
                            '‚Ñπ',
                            style={
                                'cursor': 'help',
                                'fontSize': '12px',
                                'fontWeight': 'bold',
                                'color': 'white',
                                'backgroundColor': '#888',
                                'borderRadius': '50%',
                                'width': '16px',
                                'height': '16px',
                                'display': 'inline-flex',
                                'alignItems': 'center',
                                'justifyContent': 'center',
                                'fontFamily': 'Arial, sans-serif',
                            },
                            title='The portion of the budget where city officials have the most discretion over how funds are used. This simulator focuses on General Fund spending, which comes primarily from property and income taxes. Other funds (like water/sewer enterprise funds) cannot be redirected to other purposes.'
                        ),
                    ]),
                    html.Div(format_currency(GENERAL_FUND), style={'fontSize': '28px', 'fontWeight': 'bold', 'color': MDIPP_MAROON}),
                ]),
            ]),
        ]),

        # Two Column Layout: Revenue and Spending
        html.Div(className='two-column-grid', style={'display': 'grid', 'gridTemplateColumns': '1fr 1fr', 'gap': '30px'}, children=[

            # REVENUE SIDE
            html.Div(className='card-padding', style={'backgroundColor': 'white', 'padding': '30px', 'borderRadius': '2px', 'boxShadow': '0 2px 8px rgba(0,0,0,0.1)', 'borderTop': f'4px solid {MDIPP_ORANGE}', 'maxHeight': '900px', 'overflowY': 'auto'}, children=[
                html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '15px'}, children=[
                    html.H2('Revenue', style={'color': MDIPP_MAROON, 'marginBottom': '0', 'fontSize': '28px', 'fontWeight': '600', 'marginRight': '12px'}),
                    html.Div(
                        '‚Ñπ',
                        id='revenue-info-icon',
                        style={
                            'cursor': 'help',
                            'fontSize': '18px',
                            'fontWeight': 'bold',
                            'color': 'white',
                            'backgroundColor': MDIPP_ORANGE,
                            'borderRadius': '50%',
                            'width': '24px',
                            'height': '24px',
                            'display': 'inline-flex',
                            'alignItems': 'center',
                            'justifyContent': 'center',
                            'fontFamily': 'Arial, sans-serif',
                            'fontStyle': 'normal',
                        },
                        title='Click to learn about revenue sources'
                    ),
                ]),
                html.Div(id='revenue-explanation', style={'display': 'none', 'marginBottom': '20px', 'padding': '15px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                    html.P([
                        html.Strong('Property Tax: '),
                        html.Span('Baltimore\'s largest revenue source. Current rate is $2.248 per $100 of assessed property value.')
                    ], style={'margin': '8px 0', 'fontSize': '14px'}),
                    html.P([
                        html.Strong('Income Tax: '),
                        html.Span('Tax on residents\' earned income. Currently 3.2%. State law caps at 3.3%.')
                    ], style={'margin': '8px 0', 'fontSize': '14px'}),
                    html.P([
                        html.Strong('Energy Tax: '),
                        html.Span('Taxes on utilities like electricity and natural gas, paid directly through BGE bills. Rates adjust annually with inflation.')
                    ], style={'margin': '8px 0', 'fontSize': '14px'}),
                    html.P([
                        html.Strong('Tax Credits: '),
                        html.Span('Homestead and Targeted Homeowners credits reduce tax bills for eligible residents but also reduce city revenue.')
                    ], style={'margin': '8px 0', 'fontSize': '14px'}),
                ]),

                # Property Tax Slider
                html.Div(id='property-tax-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                    html.Label('Property Tax Rate (per $100 assessed value)', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '12px', 'fontSize': '16px'}),
                    dcc.Slider(
                        id='property-tax-slider',
                        min=1.0,
                        max=2.5,
                        step=0.05,
                        value=CURRENT_PROPERTY_TAX_RATE,
                        marks={i: {'label': f'${i:.2f}', 'style': {'color': MDIPP_MAROON}} for i in [1.0, 1.5, 2.0, 2.5]},
                        tooltip={"placement": "bottom", "always_visible": True},
                    ),
                    html.Div(id='property-tax-revenue-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600'}),

                    # Homestead Credit Slider (nested under Property Tax)
                    html.Div(id='homestead-container', style={'marginTop': '25px', 'paddingTop': '20px', 'borderTop': '1px solid #E8E8E8'}, children=[
                        html.Label('Homestead Tax Credit Cap (%)', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '5px', 'fontSize': '15px'}),
                        html.Div([
                            html.Span('‚ö†Ô∏è State maximum is 10%. ', style={'fontSize': '13px', 'color': '#D97706', 'fontStyle': 'italic'}),
                            html.Span('Higher caps = less homeowner protection but lower city costs.',
                                     style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                        ], style={'marginBottom': '12px'}),
                        dcc.Slider(
                            id='homestead-slider',
                            min=4.0,
                            max=MAX_HOMESTEAD_CAP,
                            step=0.5,
                            value=CURRENT_HOMESTEAD_CAP,
                            marks={i: {'label': f'{i:.0f}%', 'style': {'color': MDIPP_MAROON}} for i in [4, 6, 8, 10]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='homestead-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600'}),
                    ]),

                    # Targeted Homeowners Credit Checkbox (nested under Property Tax)
                    html.Div(id='targeted-homeowners-container', style={'marginTop': '25px', 'paddingTop': '20px', 'borderTop': '1px solid #E8E8E8'}, children=[
                        html.Label('Targeted Homeowners Tax Credit', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '15px'}),
                        html.Div('Credit based on improvement assessment values for owner-occupied properties with approved Homestead application.',
                                style={'fontSize': '13px', 'color': '#666', 'marginBottom': '12px', 'fontStyle': 'italic'}),
                        dcc.Checklist(
                            id='targeted-homeowners-checklist',
                            options=[
                                {'label': html.Div([
                                    html.Span('Eliminate this credit ', style={'fontWeight': '600'}),
                                    html.Span('(costs $32M/year)', style={'color': MDIPP_DARK_GRAY})
                                ]), 'value': 'eliminate'}
                            ],
                            value=[],
                            labelStyle={'display': 'block', 'cursor': 'pointer'},
                            inputStyle={'marginRight': '10px', 'transform': 'scale(1.2)'}
                        ),
                        html.Div(id='targeted-homeowners-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600'}),
                    ]),
                ]),

                # Income Tax Slider
                html.Div(id='income-tax-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                    html.Label('Income Tax Rate (%)', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '5px', 'fontSize': '16px'}),
                    html.Div('‚ö†Ô∏è State law caps at 3.3%', style={'fontSize': '13px', 'color': '#D97706', 'marginBottom': '12px', 'fontStyle': 'italic'}),
                    dcc.Slider(
                        id='income-tax-slider',
                        min=1.0,
                        max=MAX_INCOME_TAX_RATE,
                        step=0.1,
                        value=CURRENT_INCOME_TAX_RATE,
                        marks={i: {'label': f'{i:.1f}%', 'style': {'color': MDIPP_MAROON}} for i in [1.0, 2.0, 3.0, 3.3]},
                        tooltip={"placement": "bottom", "always_visible": True},
                    ),
                    html.Div(id='income-tax-revenue-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600'}),
                ]),

                # Energy Tax Slider
                html.Div(id='energy-tax-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                    html.Label('Energy Tax Adjustment (%)', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '5px', 'fontSize': '16px'}),
                    html.Div([
                        html.Span('Unit taxes on electricity, natural gas, fuel oil, LPG, and steam. ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                        html.Span('Rates adjust annually by CPI. Current FY26 revenue: $51.8M.', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                    ], style={'marginBottom': '12px'}),
                    dcc.Slider(
                        id='energy-tax-slider',
                        min=ENERGY_TAX_MIN_PERCENT,
                        max=ENERGY_TAX_MAX_PERCENT,
                        step=5,
                        value=0,
                        marks={i: {'label': f'{i:+d}%' if i != 0 else '0%', 'style': {'color': MDIPP_MAROON}} for i in [-20, -10, 0, 10, 20]},
                        tooltip={"placement": "bottom", "always_visible": True},
                    ),
                    html.Div(id='energy-tax-revenue-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600'}),
                ]),

                # Total Revenue Change Summary
                html.Div(style={'padding': '25px', 'backgroundColor': MDIPP_LIGHT_GRAY, 'borderRadius': '2px', 'marginTop': '25px', 'position': 'sticky', 'bottom': '0', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                    html.H3('Total Revenue Change', style={'color': MDIPP_MAROON, 'fontSize': '20px', 'marginBottom': '12px', 'fontWeight': '600'}),
                    html.Div(id='total-revenue-change-display', style={'fontSize': '24px', 'fontWeight': 'bold'}),
                ]),
            ]),

            # SPENDING SIDE
            html.Div(className='card-padding', style={'backgroundColor': 'white', 'padding': '30px', 'borderRadius': '2px', 'boxShadow': '0 2px 8px rgba(0,0,0,0.1)', 'borderTop': f'4px solid {MDIPP_MAROON}', 'maxHeight': '900px', 'overflowY': 'auto'}, children=[
                html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '15px'}, children=[
                    html.H2('Spending', style={'color': MDIPP_MAROON, 'marginBottom': '0', 'fontSize': '28px', 'fontWeight': '600', 'marginRight': '12px'}),
                    html.Div(
                        '‚Ñπ',
                        id='spending-info-icon',
                        style={
                            'cursor': 'help',
                            'fontSize': '18px',
                            'fontWeight': 'bold',
                            'color': 'white',
                            'backgroundColor': MDIPP_ORANGE,
                            'borderRadius': '50%',
                            'width': '24px',
                            'height': '24px',
                            'display': 'inline-flex',
                            'alignItems': 'center',
                            'justifyContent': 'center',
                            'fontFamily': 'Arial, sans-serif',
                            'fontStyle': 'normal',
                        },
                        title='Click to learn about spending'
                    ),
                ]),
                html.Div(id='spending-explanation', style={'display': 'none', 'marginBottom': '20px', 'padding': '15px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                    html.P([
                        html.Span('This simulator focuses on '),
                        html.Strong('General Fund spending '),
                        html.Span('- the portion of the budget where city officials have the most discretion. Each agency\'s total budget may be larger, but this shows only the General Fund portion that can be reallocated.')
                    ], style={'margin': '8px 0', 'fontSize': '14px'}),
                ]),

                html.P('Agency Budgets (¬±50%)', style={'color': MDIPP_DARK_GRAY, 'marginBottom': '8px', 'fontSize': '20px', 'fontWeight': '600'}),
                html.P('General Fund amounts shown - where city officials have large discretion over fund usage', style={'color': '#888', 'marginBottom': '20px', 'fontSize': '13px'}),

                # Agency sliders with tooltips and color-coding
                html.Div(children=[
                    html.Div(id=f'agency-container-{i}', style={'marginBottom': '30px', 'paddingBottom': '20px', 'borderBottom': '1px solid #E8E8E8'}, children=[
                        # Agency name with info icon
                        html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '6px'}, children=[
                            html.Label(agency, style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'fontSize': '15px', 'marginRight': '8px'}),
                            html.Div(
                                '‚Ñπ',
                                id=f'agency-info-icon-{i}',
                                style={
                                    'cursor': 'help',
                                    'fontSize': '14px',
                                    'fontWeight': 'bold',
                                    'color': 'white',
                                    'backgroundColor': '#888',
                                    'borderRadius': '50%',
                                    'width': '18px',
                                    'height': '18px',
                                    'display': 'inline-flex',
                                    'alignItems': 'center',
                                    'justifyContent': 'center',
                                    'fontFamily': 'Arial, sans-serif',
                                    'fontStyle': 'normal',
                                    'border': '1px solid #666'
                                },
                                title=agency_info.get(agency, '')
                            ),
                        ]),
                        html.Div(f'Original: ${budget:.1f}M', style={'fontSize': '13px', 'color': '#666', 'marginBottom': '10px'}),
                        dcc.Slider(
                            id=f'agency-slider-{i}',
                            min=-50,
                            max=50,
                            step=1,
                            value=0,
                            marks={-50: {'label': '-50%', 'style': {'color': MDIPP_MAROON}},
                                   -25: {'label': '-25%', 'style': {'color': MDIPP_MAROON}},
                                   0: {'label': '0%', 'style': {'color': MDIPP_MAROON}},
                                   25: {'label': '+25%', 'style': {'color': MDIPP_MAROON}},
                                   50: {'label': '+50%', 'style': {'color': MDIPP_MAROON}}},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id=f'agency-display-{i}', style={'marginTop': '10px', 'fontSize': '14px', 'fontWeight': '600'}),
                    ]) for i, (agency, budget) in enumerate(agencies.items())
                ]),

                # Spending Summary
                html.Div(style={'padding': '25px', 'backgroundColor': MDIPP_LIGHT_GRAY, 'borderRadius': '2px', 'marginTop': '25px', 'position': 'sticky', 'bottom': '0', 'borderLeft': f'4px solid {MDIPP_MAROON}'}, children=[
                    html.H3('Total Spending Change', style={'color': MDIPP_MAROON, 'fontSize': '20px', 'marginBottom': '12px', 'fontWeight': '600'}),
                    html.Div(id='total-spending-change', style={'fontSize': '24px', 'fontWeight': 'bold'}),
                ]),
            ]),
        ]),

        # NEW: Other Reforms Section (Full Width)
        html.Div(className='card-padding', style={'backgroundColor': 'white', 'padding': '30px', 'borderRadius': '2px', 'marginTop': '30px', 'boxShadow': '0 2px 8px rgba(0,0,0,0.1)', 'borderTop': f'4px solid {MDIPP_ORANGE}'}, children=[
            html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '15px'}, children=[
                html.H2('Other Reforms', style={'color': MDIPP_MAROON, 'marginBottom': '0', 'fontSize': '28px', 'fontWeight': '600', 'marginRight': '12px'}),
                html.Div(
                    '‚Ñπ',
                    id='reforms-info-icon',
                    style={
                        'cursor': 'help',
                        'fontSize': '18px',
                        'fontWeight': 'bold',
                        'color': 'white',
                        'backgroundColor': MDIPP_ORANGE,
                        'borderRadius': '50%',
                        'width': '24px',
                        'height': '24px',
                        'display': 'inline-flex',
                        'alignItems': 'center',
                        'justifyContent': 'center',
                        'fontFamily': 'Arial, sans-serif',
                        'fontStyle': 'normal',
                    },
                    title='Click to learn about these policy reforms'
                ),
            ]),
            html.Div(id='reforms-explanation', style={'display': 'none', 'marginBottom': '20px', 'padding': '15px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                html.P([
                    html.Span('These are '),
                    html.Strong('policy ideas '),
                    html.Span('that Baltimore could adopt. Cost estimates are based on research and comparable programs in other cities. These reforms are not currently part of the FY26 budget.')
                ], style={'margin': '8px 0', 'fontSize': '14px'}),
            ]),
            html.P('Explore progressive policy ideas for Baltimore', style={'color': '#666', 'marginBottom': '10px', 'fontStyle': 'italic'}),
            html.P([
                html.Span('Have a policy idea that you\'d like to add to the simulation? Email your idea to ', style={'color': '#666', 'fontSize': '14px'}),
                html.A('nate@mdipp.org', href='mailto:nate@mdipp.org', style={'color': MDIPP_ORANGE, 'textDecoration': 'none', 'fontWeight': '600'}),
                html.Span(' and we will do our best to estimate the cost and add it to the site!', style={'color': '#666', 'fontSize': '14px'})
            ], style={'marginBottom': '30px', 'padding': '15px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'3px solid {MDIPP_ORANGE}'}),

            # REVENUE SECTION
            html.H3('Revenue from Tax-Exempt Institutions', style={'color': MDIPP_MAROON, 'marginTop': '30px', 'marginBottom': '20px', 'fontSize': '22px', 'fontWeight': '600', 'borderBottom': f'2px solid {MDIPP_MAROON}', 'paddingBottom': '10px'}),

            html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '15px'}, children=[
                html.Div(
                    '‚Ñπ',
                    id='meds-eds-info-icon',
                    style={
                        'cursor': 'help',
                        'fontSize': '18px',
                        'fontWeight': 'bold',
                        'color': 'white',
                        'backgroundColor': MDIPP_ORANGE,
                        'borderRadius': '50%',
                        'width': '24px',
                        'height': '24px',
                        'display': 'inline-flex',
                        'alignItems': 'center',
                        'justifyContent': 'center',
                        'fontFamily': 'Arial, sans-serif',
                        'fontStyle': 'normal',
                    },
                    title='Click to learn more about meds & eds tax exemptions'
                ),
            ]),

            html.Div(id='meds-eds-explanation', style={'display': 'none', 'marginBottom': '20px', 'padding': '15px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                html.P([
                    html.Strong('Context: '),
                    'Baltimore\'s 14 largest hospitals and universities (Johns Hopkins, UMD Medical Center, MedStar, Sinai, Loyola, MICA, etc.) own $5 billion in tax-exempt property. ',
                    'They currently pay just $6-12M annually under a PILOT (Payment in Lieu of Taxes) agreement, while using an estimated $47.7M in city services. ',
                    'If fully taxed, their property would generate ~$108M annually in revenue.'
                ], style={'margin': '0 0 12px 0', 'fontSize': '14px', 'lineHeight': '1.6', 'color': '#666'}),
                html.P([
                    html.Strong('Important: '),
                    'These institutions are exempt from property taxes under Maryland state law, not city policy. ',
                    'Baltimore City cannot unilaterally remove these exemptions‚Äîthis would require action by the Maryland General Assembly. ',
                    'The options below represent what revenue could be generated if state law were changed, or if the city negotiated more aggressively for larger PILOT contributions.'
                ], style={'margin': '0', 'fontSize': '14px', 'lineHeight': '1.6', 'color': '#666', 'fontStyle': 'italic'}),
            ]),

            html.Div(className='two-column-grid', style={'display': 'grid', 'gridTemplateColumns': '1fr 1fr', 'gap': '30px', 'marginBottom': '40px'}, children=[
                # Left Column - Full Property Tax
                html.Div(children=[
                    html.Div(id='meds-eds-property-tax-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '12px'}, children=[
                            html.Label('Make Meds & Eds Pay Full Property Tax', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'fontSize': '16px', 'marginRight': '8px'}),
                            html.Span('‚ìò',
                                     title='The 14 largest hospitals and universities studied by the Baltimore City Comptroller: Johns Hopkins University and Hospital, University of Maryland Medical Center (Downtown & Midtown), MedStar hospitals, Sinai Hospital, Grace Medical Center, Loyola University Maryland, Maryland Institute College of Art, and Notre Dame of Maryland University.',
                                     style={'color': MDIPP_ORANGE, 'cursor': 'help', 'fontSize': '16px', 'fontWeight': 'bold'}),
                        ]),
                        html.Div([
                            html.Span(f'Currently exempt from ~${MEDS_EDS_FULL_PROPERTY_TAX:.0f}M in annual property taxes (paying ${MEDS_EDS_CURRENT_PILOT:.0f}M PILOT instead). ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                            html.Span('This would treat them like any other property owner.', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                        ], style={'marginBottom': '15px'}),
                        dcc.Checklist(
                            id='meds-eds-property-tax-checkbox',
                            options=[
                                {'label': f' Require full property tax payment (+${MEDS_EDS_FULL_PROPERTY_TAX - MEDS_EDS_CURRENT_PILOT:.0f}M net revenue)', 'value': 'full_tax'}
                            ],
                            value=[],
                            style={'fontSize': '14px'}
                        ),
                        html.Div(id='meds-eds-property-tax-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': '#16A34A'}),
                    ]),
                ]),

                # Right Column - Pay for Services
                html.Div(children=[
                    html.Div(id='meds-eds-services-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Div(style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '12px'}, children=[
                            html.Label('Make Meds & Eds Pay for City Services Used', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'fontSize': '16px', 'marginRight': '8px'}),
                            html.Span('‚ìò',
                                     title='The 14 largest hospitals and universities studied by the Baltimore City Comptroller: Johns Hopkins University and Hospital, University of Maryland Medical Center (Downtown & Midtown), MedStar hospitals, Sinai Hospital, Grace Medical Center, Loyola University Maryland, Maryland Institute College of Art, and Notre Dame of Maryland University.',
                                     style={'color': MDIPP_ORANGE, 'cursor': 'help', 'fontSize': '16px', 'fontWeight': 'bold'}),
                        ]),
                        html.Div([
                            html.Span(f'They use ${MEDS_EDS_SERVICES_COST:.1f}M in city services (police, fire, roads, etc.) but currently pay only ${MEDS_EDS_CURRENT_PILOT:.0f}M. ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                            html.Span('This would make them cover their actual costs.', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                        ], style={'marginBottom': '15px'}),
                        dcc.Checklist(
                            id='meds-eds-services-checkbox',
                            options=[
                                {'label': f' Require payment for services used (+${MEDS_EDS_SERVICES_COST - MEDS_EDS_CURRENT_PILOT:.1f}M revenue)', 'value': 'services_cost'}
                            ],
                            value=[],
                            style={'fontSize': '14px'}
                        ),
                        html.Div(id='meds-eds-services-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': '#16A34A'}),
                    ]),
                ]),
            ]),

            # CHILD POVERTY SECTION
            html.H3('Child Poverty', style={'color': MDIPP_MAROON, 'marginTop': '30px', 'marginBottom': '20px', 'fontSize': '22px', 'fontWeight': '600', 'borderBottom': f'2px solid {MDIPP_MAROON}', 'paddingBottom': '10px'}),

            html.Div(className='two-column-grid', style={'display': 'grid', 'gridTemplateColumns': '1fr 1fr', 'gap': '30px', 'marginBottom': '40px'}, children=[
                # Left Column - Child Benefit
                html.Div(children=[
                    # Universal Child Benefit
                    html.Div(id='child-benefit-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Universal Child Benefit', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div('Provides direct cash payments to families with children', style={'fontSize': '13px', 'color': '#666', 'marginBottom': '15px', 'fontStyle': 'italic'}),

                        # Age slider
                        html.Label('Maximum Age (includes all children this age and under)', style={'fontWeight': '500', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '14px', 'marginTop': '15px'}),
                        dcc.Slider(
                            id='child-benefit-age-slider',
                            min=0,
                            max=17,
                            step=1,
                            value=0,
                            marks={i: {'label': f'{i}', 'style': {'color': MDIPP_MAROON}} for i in [0, 5, 10, 15, 17]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),

                        # Amount slider
                        html.Label('Monthly Benefit Amount (per child)', style={'fontWeight': '500', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '14px', 'marginTop': '20px'}),
                        dcc.Slider(
                            id='child-benefit-slider',
                            min=0,
                            max=500,
                            step=50,
                            value=0,
                            marks={i: {'label': f'${i}', 'style': {'color': MDIPP_MAROON}} for i in [0, 100, 200, 300, 400, 500]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='child-benefit-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),
                ]),

                # Right Column - Baby Bonus
                html.Div(children=[
                    # Baby Bonus
                    html.Div(id='baby-bonus-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Baby Bonus (one-time payment per birth)', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div(f'One-time payment for each of ~{BABIES_PER_YEAR:,} babies born annually', style={'fontSize': '13px', 'color': '#666', 'marginBottom': '12px', 'fontStyle': 'italic'}),
                        dcc.Slider(
                            id='baby-bonus-slider',
                            min=0,
                            max=3000,
                            step=100,
                            value=0,
                            marks={i: {'label': f'${i}', 'style': {'color': MDIPP_MAROON}} for i in [0, 1000, 2000, 3000]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='baby-bonus-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),
                ]),
            ]),

            # HOUSING SECTION
            html.H3('Housing', style={'color': MDIPP_MAROON, 'marginTop': '40px', 'marginBottom': '20px', 'fontSize': '22px', 'fontWeight': '600', 'borderBottom': f'2px solid {MDIPP_MAROON}', 'paddingBottom': '10px'}),

            html.Div(className='two-column-grid', style={'display': 'grid', 'gridTemplateColumns': '1fr 1fr', 'gap': '30px', 'marginBottom': '40px'}, children=[
                # Left Column - Vacant Rehab
                html.Div(children=[
                    # Vacant Home Rehab Slider
                    html.Div(id='vacant-rehab-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Vacant Home Rehabilitation Program', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div([
                            html.Span(f'Rehab vacant homes at ~$150k per home. ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                            html.Span(f'There are approximately {TOTAL_VACANT_HOMES:,} vacant homes in Baltimore, of which the city currently owns about {CITY_OWNED_VACANT_HOMES:,}. ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                            html.A('See vacant building data dashboard.',
                                  href='https://www.arcgis.com/apps/dashboards/79c1dd09bd434d21a0b0c38bbb13c66c',
                                  target='_blank',
                                  style={'fontSize': '13px', 'color': MDIPP_ORANGE, 'fontStyle': 'italic', 'textDecoration': 'none', 'fontWeight': '600'})
                        ], style={'marginBottom': '12px'}),
                        dcc.Slider(
                            id='vacant-rehab-slider',
                            min=0,
                            max=1000,
                            step=50,
                            value=0,
                            marks={i: {'label': f'{i}', 'style': {'color': MDIPP_MAROON}} for i in [0, 250, 500, 750, 1000]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='vacant-rehab-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),
                ]),

                # Right Column - Public Housing
                html.Div(children=[
                    # Public Housing Construction
                    html.Div(id='public-housing-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Build Public Housing', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div([
                            html.Span('Construct new affordable housing units at ~$300k per unit.', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                        ], style={'marginBottom': '12px'}),
                        dcc.Slider(
                            id='public-housing-slider',
                            min=0,
                            max=500,
                            step=25,
                            value=0,
                            marks={i: {'label': f'{i}', 'style': {'color': MDIPP_MAROON}} for i in [0, 125, 250, 375, 500]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='public-housing-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),
                ]),
            ]),

            # TRANSIT SECTION
            html.H3('Transit', style={'color': MDIPP_MAROON, 'marginTop': '40px', 'marginBottom': '20px', 'fontSize': '22px', 'fontWeight': '600', 'borderBottom': f'2px solid {MDIPP_MAROON}', 'paddingBottom': '10px'}),

            html.Div(className='two-column-grid', style={'display': 'grid', 'gridTemplateColumns': '1fr 1fr', 'gap': '30px', 'marginBottom': '40px'}, children=[
                # Left Column - Circulator
                html.Div(children=[
                    html.Div(id='circulator-headways-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Charm City Circulator: Reduce Headways by 50%', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div([
                            html.Span(f'Double frequency on existing {CIRCULATOR_EXISTING_ROUTES} routes (from 10-15 min to 5-7.5 min). ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                            html.Span('Requires doubling buses and drivers.', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                        ], style={'marginBottom': '12px'}),
                        dcc.Checklist(
                            id='circulator-headways-checkbox',
                            options=[
                                {'label': html.Span('Reduce headways by 50%', style={'fontWeight': '600'}), 'value': 'reduce'}
                            ],
                            value=[],
                            labelStyle={'display': 'block', 'cursor': 'pointer'},
                            inputStyle={'marginRight': '10px', 'transform': 'scale(1.2)'}
                        ),
                        html.Div(id='circulator-headways-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),

                    # Charm City Circulator - New Routes Slider
                    html.Div(id='circulator-routes-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Charm City Circulator: Add New Routes', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div([
                            html.Span('Add new Circulator routes. ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                            html.Span('Cost per route depends on whether headways are reduced system-wide.', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                        ], style={'marginBottom': '12px'}),
                        dcc.Slider(
                            id='circulator-routes-slider',
                            min=0,
                            max=3,
                            step=1,
                            value=0,
                            marks={i: {'label': f'{i}', 'style': {'color': MDIPP_MAROON}} for i in [0, 1, 2, 3]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='circulator-routes-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),

                    # Protected Bus Lanes
                    html.Div(id='bus-lanes-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Build Protected Bus Lanes (miles)', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div([
                            html.Span('Protected bus lanes with physical barriers at ~$300k per mile. ', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'}),
                            html.Span('Improves bus speed and reliability citywide.', style={'fontSize': '13px', 'color': '#666', 'fontStyle': 'italic'})
                        ], style={'marginBottom': '12px'}),
                        dcc.Slider(
                            id='bus-lanes-slider',
                            min=0,
                            max=100,
                            step=5,
                            value=0,
                            marks={i: {'label': f'{i}mi', 'style': {'color': MDIPP_MAROON}} for i in [0, 20, 40, 60, 80, 100]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='bus-lanes-new-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),
                ]),

                # Right Column - Bike Lanes
                html.Div(children=[
                    # Protected Bike Lanes
                    html.Div(id='bike-lanes-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Protected Bike Lanes (miles)', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '8px', 'fontSize': '16px'}),
                        html.Div('Build protected bike infrastructure citywide at ~$150k per mile', style={'fontSize': '13px', 'color': '#666', 'marginBottom': '12px', 'fontStyle': 'italic'}),
                        dcc.Slider(
                            id='bike-lanes-slider',
                            min=0,
                            max=100,
                            step=5,
                            value=0,
                            marks={i: {'label': f'{i}mi', 'style': {'color': MDIPP_MAROON}} for i in [0, 20, 40, 60, 80, 100]},
                            tooltip={"placement": "bottom", "always_visible": True},
                        ),
                        html.Div(id='bike-lanes-display', style={'marginTop': '12px', 'fontSize': '14px', 'fontWeight': '600', 'color': MDIPP_ORANGE}),
                    ]),

                    # Water Taxi Checkboxes
                    html.Div(id='water-taxi-container', style={'marginBottom': '35px', 'paddingBottom': '25px', 'borderBottom': '2px solid #E8E8E8'}, children=[
                        html.Label('Water Taxi Improvements', style={'fontWeight': '600', 'color': MDIPP_DARK_GRAY, 'display': 'block', 'marginBottom': '15px', 'fontSize': '16px'}),

                        dcc.Checklist(
                            id='policy-checklist',
                            options=[
                                {'label': html.Div([
                                    html.Span('Make Water Taxi Free Year-Round & Run 7 Days/Week ', style={'fontWeight': '600'}),
                                    html.Span(f'(${WATER_TAXI_FREE_YEAR_ROUND:.0f}M/year)', style={'color': '#666'})
                                ]), 'value': 'water_taxi_free'},
                                {'label': html.Div([
                                    html.Span('Add Additional Water Taxi Route ', style={'fontWeight': '600'}),
                                    html.Span(f'(${WATER_TAXI_ADDITIONAL_ROUTE:.0f}M/year)', style={'color': '#666'})
                                ]), 'value': 'water_taxi_route'},
                            ],
                            value=[],
                            style={'fontSize': '15px'},
                            labelStyle={'display': 'block', 'marginBottom': '20px', 'cursor': 'pointer', 'padding': '15px', 'backgroundColor': MDIPP_LIGHT_GRAY, 'borderRadius': '4px', 'border': '1px solid #E8E8E8'},
                            inputStyle={'marginRight': '12px', 'transform': 'scale(1.3)'}
                        ),
                    ]),

                    html.Div(style={'marginTop': '30px', 'padding': '20px', 'backgroundColor': '#FFF9F0', 'borderRadius': '4px', 'borderLeft': f'4px solid {MDIPP_ORANGE}'}, children=[
                        html.Div('Total Cost of Reforms', style={'fontSize': '14px', 'color': '#666', 'marginBottom': '8px', 'textTransform': 'uppercase', 'letterSpacing': '0.5px'}),
                        html.Div(id='reforms-total-cost', style={'fontSize': '24px', 'fontWeight': 'bold', 'color': MDIPP_MAROON}),
                    ]),
                ]),
            ]),
        ]),
    ]),

    # Footer
    html.Div(className='section-padding', style={'backgroundColor': MDIPP_MAROON, 'padding': '30px 20px', 'marginTop': '50px', 'textAlign': 'center', 'color': 'white'}, children=[
        html.P('Maryland Institute for Progressive Policy', style={'margin': '0', 'fontSize': '16px', 'fontWeight': '300'}),
        html.P('Because Policy Affects People', style={'margin': '5px 0 0 0', 'fontSize': '14px', 'fontStyle': 'italic', 'opacity': '0.9'}),
    ]),
])

# URL and sharing callbacks
from urllib.parse import parse_qs, urlencode, urlparse
import json

# Callback to parse URL and store initial values (runs once on page load)
@app.callback(
    Output('initial-values-store', 'data'),
    Input('url', 'href'),
    prevent_initial_call=False
)
def parse_url_to_store(href):
    if not href:
        return None

    try:
        parsed = urlparse(href)
        params = parse_qs(parsed.query)

        if not params:
            return None

        # Extract all parameters
        initial_values = {
            'pt': float(params.get('pt', [CURRENT_PROPERTY_TAX_RATE])[0]),
            'it': float(params.get('it', [CURRENT_INCOME_TAX_RATE])[0]),
            'et': float(params.get('et', [0])[0]),  # energy tax adjustment
            'hs': float(params.get('hs', [CURRENT_HOMESTEAD_CAP])[0]),
            'th': params.get('th', [''])[0].split(',') if params.get('th', [''])[0] else [],  # targeted homeowners
            'ca': int(params.get('ca', [0])[0]),
            'cb': int(params.get('cb', [0])[0]),
            'bb': int(params.get('bb', [0])[0]),
            'bl': int(params.get('bl', [0])[0]),
            'vr': int(params.get('vr', [0])[0]),  # vacant rehab slider
            'ph': int(params.get('ph', [0])[0]),  # public housing slider
            'ch': params.get('ch', [''])[0].split(',') if params.get('ch', [''])[0] else [],  # circulator headways
            'cr': int(params.get('cr', [0])[0]),  # circulator routes
            'blm': int(params.get('blm', [0])[0]),  # bus lanes miles
            'pc': params.get('pc', [''])[0].split(',') if params.get('pc', [''])[0] else [],
        }

        # Add agency values
        for i in range(len(agencies)):
            initial_values[f'a{i}'] = int(params.get(f'a{i}', [0])[0])

        return initial_values
    except Exception as e:
        print(f"Error parsing URL: {e}")
        return None

# Callback to set initial values from URL on all sliders (runs once)
@app.callback(
    [Output('property-tax-slider', 'value', allow_duplicate=True),
     Output('income-tax-slider', 'value', allow_duplicate=True),
     Output('energy-tax-slider', 'value', allow_duplicate=True),
     Output('homestead-slider', 'value', allow_duplicate=True),
     Output('targeted-homeowners-checklist', 'value', allow_duplicate=True),
     Output('child-benefit-age-slider', 'value', allow_duplicate=True),
     Output('child-benefit-slider', 'value', allow_duplicate=True),
     Output('baby-bonus-slider', 'value', allow_duplicate=True),
     Output('bike-lanes-slider', 'value', allow_duplicate=True),
     Output('vacant-rehab-slider', 'value', allow_duplicate=True),
     Output('public-housing-slider', 'value', allow_duplicate=True),
     Output('circulator-headways-checkbox', 'value', allow_duplicate=True),
     Output('circulator-routes-slider', 'value', allow_duplicate=True),
     Output('bus-lanes-slider', 'value', allow_duplicate=True),
     Output('policy-checklist', 'value', allow_duplicate=True)] +
    [Output(f'agency-slider-{i}', 'value', allow_duplicate=True) for i in range(len(agencies))],
    Input('initial-values-store', 'data'),
    prevent_initial_call=True
)
def set_initial_values_from_url(data):
    if not data:
        # No URL params, return defaults
        return [CURRENT_PROPERTY_TAX_RATE, CURRENT_INCOME_TAX_RATE, 0, CURRENT_HOMESTEAD_CAP, [],
                0, 0, 0, 0, 0, 0, [], 0, 0, []] + [0] * len(agencies)

    # Extract values from stored data
    agency_values = [data.get(f'a{i}', 0) for i in range(len(agencies))]

    return [data['pt'], data['it'], data['et'], data['hs'], data['th'], data['ca'], data['cb'],
            data['bb'], data['bl'], data['vr'], data['ph'], data['ch'], data['cr'], data['blm'], data['pc']] + agency_values

# Callback to generate shareable link
@app.callback(
    Output('share-link-display', 'children'),
    Input('generate-link-button', 'n_clicks'),
    [State('property-tax-slider', 'value'),
     State('income-tax-slider', 'value'),
     State('energy-tax-slider', 'value'),
     State('homestead-slider', 'value'),
     State('targeted-homeowners-checklist', 'value'),
     State('child-benefit-age-slider', 'value'),
     State('child-benefit-slider', 'value'),
     State('baby-bonus-slider', 'value'),
     State('bike-lanes-slider', 'value'),
     State('vacant-rehab-slider', 'value'),
     State('public-housing-slider', 'value'),
     State('circulator-headways-checkbox', 'value'),
     State('circulator-routes-slider', 'value'),
     State('bus-lanes-slider', 'value'),
     State('policy-checklist', 'value')] +
    [State(f'agency-slider-{i}', 'value') for i in range(len(agencies))] +
    [State('url', 'href')],
    prevent_initial_call=True
)
def generate_share_link(n_clicks, property_tax, income_tax, energy_tax, homestead, targeted_homeowners,
                       child_age, child_amt, baby_bonus, bike_lanes, vacant_rehab, public_housing,
                       circulator_headways, circulator_routes, bus_lanes_miles, policies, *args):
    # n_clicks will be at least 1 when button is clicked
    if not n_clicks or n_clicks == 0:
        return ""

    try:
        # Last argument is the current URL href
        agency_values = args[:-1]
        current_href = args[-1]

        # Build URL parameters
        params = {
            'pt': property_tax,
            'it': income_tax,
            'et': energy_tax,
            'hs': homestead,
            'ca': child_age,
            'cb': child_amt,
            'bb': baby_bonus,
            'bl': bike_lanes,
            'vr': vacant_rehab,
            'ph': public_housing,
            'cr': circulator_routes,
            'blm': bus_lanes_miles,  # bus lanes miles
        }

        # Only add targeted homeowners if checked
        if targeted_homeowners:
            params['th'] = ','.join(targeted_homeowners)

        # Only add circulator headways if checked
        if circulator_headways:
            params['ch'] = ','.join(circulator_headways)

        # Only add policy checklist if there are policies selected
        if policies:
            params['pc'] = ','.join(policies)

        # Add agency parameters (only non-zero)
        for i, val in enumerate(agency_values):
            if val != 0:
                params[f'a{i}'] = val

        # Create query string
        query_string = urlencode(params)

        # Get base URL
        parsed = urlparse(current_href)
        base_url = f"{parsed.scheme}://{parsed.netloc}{parsed.path}"
        share_url = f"{base_url}?{query_string}"

        return html.Div(style={'backgroundColor': 'white', 'padding': '15px', 'borderRadius': '4px', 'border': f'2px solid {MDIPP_ORANGE}'}, children=[
            html.Div('Share this link:', style={'fontWeight': '600', 'marginBottom': '10px', 'color': MDIPP_MAROON}),
            html.Div(style={'display': 'flex', 'gap': '10px', 'alignItems': 'center', 'flexWrap': 'wrap'}, children=[
                dcc.Input(
                    id='share-link-input',
                    type='text',
                    value=share_url,
                    readOnly=True,
                    style={
                        'flex': '1',
                        'minWidth': '300px',
                        'padding': '10px',
                        'border': '1px solid #ccc',
                        'borderRadius': '4px',
                        'fontSize': '14px',
                        'fontFamily': 'monospace',
                        'width': '100%'
                    }
                ),
                html.Button('üìã Copy',
                           id='copy-link-button',
                           n_clicks=0,
                           style={
                               'padding': '10px 20px',
                               'backgroundColor': MDIPP_MAROON,
                               'color': 'white',
                               'border': 'none',
                               'borderRadius': '4px',
                               'cursor': 'pointer',
                               'fontSize': '14px',
                               'fontWeight': '600'
                           })
            ]),
            html.Div(id='copy-confirmation', style={'marginTop': '10px', 'color': '#16A34A', 'fontSize': '14px', 'fontWeight': '600'})
        ])

    except Exception as e:
        print(f"Error generating share link: {e}")
        import traceback
        traceback.print_exc()
        return html.Div(f"Error generating link: {str(e)}", style={'color': 'red', 'padding': '10px'})

# Callback to copy link to clipboard (uses clientside callback for clipboard access)
app.clientside_callback(
    """
    function(n_clicks) {
        if (n_clicks > 0) {
            var copyText = document.getElementById('share-link-input');
            if (copyText) {
                // For dcc.Input, we need to access the actual input element
                var inputElement = copyText.querySelector('input') || copyText;
                inputElement.select();
                inputElement.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(inputElement.value).then(function() {
                    console.log('Link copied successfully');
                }).catch(function(err) {
                    console.error('Failed to copy: ', err);
                });
                return '‚úì Link copied to clipboard!';
            }
        }
        return '';
    }
    """,
    Output('copy-confirmation', 'children'),
    Input('copy-link-button', 'n_clicks'),
    prevent_initial_call=True
)

# Reset callback
@app.callback(
    [Output('property-tax-slider', 'value'),
     Output('income-tax-slider', 'value'),
     Output('energy-tax-slider', 'value'),
     Output('homestead-slider', 'value'),
     Output('targeted-homeowners-checklist', 'value'),
     Output('meds-eds-property-tax-checkbox', 'value'),
     Output('meds-eds-services-checkbox', 'value'),
     Output('child-benefit-age-slider', 'value'),
     Output('child-benefit-slider', 'value'),
     Output('baby-bonus-slider', 'value'),
     Output('bike-lanes-slider', 'value'),
     Output('vacant-rehab-slider', 'value'),
     Output('public-housing-slider', 'value'),
     Output('circulator-headways-checkbox', 'value'),
     Output('circulator-routes-slider', 'value'),
     Output('bus-lanes-slider', 'value'),
     Output('policy-checklist', 'value')] +
    [Output(f'agency-slider-{i}', 'value') for i in range(len(agencies))],
    Input('reset-button', 'n_clicks'),
    prevent_initial_call=True
)
def reset_all(n_clicks):
    # Reset all sliders and checkboxes to default values
    return [CURRENT_PROPERTY_TAX_RATE, CURRENT_INCOME_TAX_RATE, 0, CURRENT_HOMESTEAD_CAP, [], [], [],
            0, 0, 0, 0, 0, 0, [], 0, 0, []] + [0] * len(agencies)

# NEW: Callback to color-code revenue slider containers based on changes
@app.callback(
    [Output('property-tax-container', 'style'),
     Output('homestead-container', 'style'),
     Output('targeted-homeowners-container', 'style'),
     Output('income-tax-container', 'style'),
     Output('energy-tax-container', 'style')],
    [Input('property-tax-slider', 'value'),
     Input('homestead-slider', 'value'),
     Input('targeted-homeowners-checklist', 'value'),
     Input('income-tax-slider', 'value'),
     Input('energy-tax-slider', 'value')]
)
def update_revenue_container_colors(property_rate, homestead_cap, targeted_homeowners_checked, income_rate, energy_percent):
    """Universal color scale: Light <$10M, Medium $10-50M, Dark >$50M"""
    styles = []

    def get_color_for_amount(amount):
        """Universal thresholds - positive = green (good), negative = red (bad)"""
        abs_amount = abs(amount)
        if amount > 0:  # Positive change = more revenue/savings = green
            if abs_amount >= 50:
                return 'rgba(22, 163, 74, 0.12)'  # Dark green - $50M+
            elif abs_amount >= 10:
                return 'rgba(22, 163, 74, 0.08)'  # Medium green - $10-50M
            else:
                return 'rgba(22, 163, 74, 0.04)'  # Light green - <$10M
        elif amount < 0:  # Negative change = less revenue = red
            if abs_amount >= 50:
                return 'rgba(220, 38, 38, 0.12)'  # Dark red - $50M+
            elif abs_amount >= 10:
                return 'rgba(220, 38, 38, 0.08)'  # Medium red - $10-50M
            else:
                return 'rgba(220, 38, 38, 0.04)'  # Light red - <$10M
        else:
            return 'transparent'

    # Property tax
    property_multiplier = property_rate / CURRENT_PROPERTY_TAX_RATE
    new_property_revenue = PROPERTY_TAX_REVENUE * property_multiplier
    property_change = new_property_revenue - PROPERTY_TAX_REVENUE

    base_style = {
        'marginBottom': '35px',
        'paddingBottom': '25px',
        'borderBottom': '2px solid #E8E8E8',
        'padding': '15px',
        'borderRadius': '4px',
        'transition': 'all 0.3s ease'
    }
    base_style['backgroundColor'] = get_color_for_amount(property_change)
    styles.append(base_style.copy())

    # Homestead credit - calculate cost change
    if homestead_cap <= CURRENT_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT
    elif homestead_cap >= MAX_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_10PCT
    else:
        pct_between = (homestead_cap - CURRENT_HOMESTEAD_CAP) / (MAX_HOMESTEAD_CAP - CURRENT_HOMESTEAD_CAP)
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT - (pct_between * (HOMESTEAD_COST_AT_4PCT - HOMESTEAD_COST_AT_10PCT))

    homestead_change = new_homestead_cost - HOMESTEAD_COST_AT_4PCT
    # Flip sign - cost decrease is good (positive), cost increase is bad (negative)
    homestead_change = -homestead_change

    base_style = {
        'marginTop': '25px',
        'paddingTop': '20px',
        'borderTop': '1px solid #E8E8E8',
        'padding': '15px',
        'borderRadius': '4px',
        'transition': 'all 0.3s ease'
    }
    base_style['backgroundColor'] = get_color_for_amount(homestead_change)
    styles.append(base_style.copy())

    # Targeted Homeowners Credit
    base_style = {
        'marginTop': '25px',
        'paddingTop': '20px',
        'borderTop': '1px solid #E8E8E8',
        'padding': '15px',
        'borderRadius': '4px',
        'transition': 'all 0.3s ease'
    }

    if 'eliminate' in targeted_homeowners_checked:
        # Eliminated = savings = positive
        base_style['backgroundColor'] = get_color_for_amount(TARGETED_HOMEOWNERS_CREDIT_COST)
    else:
        # Not eliminated = no change
        base_style['backgroundColor'] = 'transparent'

    styles.append(base_style.copy())

    # Income tax
    income_multiplier = income_rate / CURRENT_INCOME_TAX_RATE
    new_income_revenue = INCOME_TAX_REVENUE * income_multiplier
    income_change = new_income_revenue - INCOME_TAX_REVENUE

    base_style = {
        'marginBottom': '35px',
        'paddingBottom': '25px',
        'borderBottom': '2px solid #E8E8E8',
        'padding': '15px',
        'borderRadius': '4px',
        'transition': 'all 0.3s ease'
    }
    base_style['backgroundColor'] = get_color_for_amount(income_change)
    styles.append(base_style.copy())

    # Energy tax
    energy_multiplier = 1 + (energy_percent / 100)
    new_energy_revenue = CURRENT_ENERGY_TAX_REVENUE * energy_multiplier
    energy_change = new_energy_revenue - CURRENT_ENERGY_TAX_REVENUE

    base_style = {
        'marginBottom': '35px',
        'paddingBottom': '25px',
        'borderBottom': '2px solid #E8E8E8',
        'padding': '15px',
        'borderRadius': '4px',
        'transition': 'all 0.3s ease'
    }
    base_style['backgroundColor'] = get_color_for_amount(energy_change)
    styles.append(base_style)

    return styles

# NEW: Callback to color-code agency slider containers
@app.callback(
    [Output(f'agency-container-{i}', 'style') for i in range(len(agencies))],
    [Input(f'agency-slider-{i}', 'value') for i in range(len(agencies))]
)
def update_agency_container_colors(*agency_values):
    styles = []

    for i, (agency, budget) in enumerate(agencies.items()):
        percent_change = agency_values[i]
        is_critical = agency in CRITICAL_SERVICES

        # Base style
        base_style = {
            'marginBottom': '30px',
            'paddingBottom': '20px',
            'borderBottom': '1px solid #E8E8E8',
            'padding': '15px',
            'borderRadius': '4px',
            'transition': 'all 0.3s ease'
        }

        # Determine background color based on change
        if percent_change > 0:
            # Increases - red tint (more spending = bad for budget), more intense for critical services
            if is_critical:
                if percent_change >= 30:
                    base_style['backgroundColor'] = 'rgba(220, 38, 38, 0.15)'  # Dark red
                elif percent_change >= 15:
                    base_style['backgroundColor'] = 'rgba(220, 38, 38, 0.10)'  # Medium red
                else:
                    base_style['backgroundColor'] = 'rgba(220, 38, 38, 0.05)'   # Light red
            else:
                if percent_change >= 30:
                    base_style['backgroundColor'] = 'rgba(220, 38, 38, 0.08)'
                else:
                    base_style['backgroundColor'] = 'rgba(220, 38, 38, 0.04)'

        elif percent_change < 0:
            # Cuts - green tint (less spending = good for budget)
            if abs(percent_change) >= 30:
                base_style['backgroundColor'] = 'rgba(22, 163, 74, 0.12)'   # Dark green
            elif abs(percent_change) >= 15:
                base_style['backgroundColor'] = 'rgba(22, 163, 74, 0.08)'   # Medium green
            else:
                base_style['backgroundColor'] = 'rgba(22, 163, 74, 0.04)'   # Light green
        else:
            # No change
            base_style['backgroundColor'] = 'transparent'

        styles.append(base_style)

    return styles

# NEW: Callback to color-code reform containers (all spending = red)
@app.callback(
    [Output('child-benefit-container', 'style'),
     Output('baby-bonus-container', 'style'),
     Output('bike-lanes-container', 'style'),
     Output('vacant-rehab-container', 'style'),
     Output('public-housing-container', 'style'),
     Output('circulator-headways-container', 'style'),
     Output('circulator-routes-container', 'style'),
     Output('bus-lanes-container', 'style'),
     Output('water-taxi-container', 'style')],
    [Input('child-benefit-age-slider', 'value'),
     Input('child-benefit-slider', 'value'),
     Input('baby-bonus-slider', 'value'),
     Input('bike-lanes-slider', 'value'),
     Input('vacant-rehab-slider', 'value'),
     Input('public-housing-slider', 'value'),
     Input('circulator-headways-checkbox', 'value'),
     Input('circulator-routes-slider', 'value'),
     Input('bus-lanes-slider', 'value'),
     Input('policy-checklist', 'value')]
)
def update_reform_container_colors(child_age, child_amt, baby_bonus, bike_lanes, vacant_rehab, public_housing,
                                   circulator_headways, circulator_routes, bus_lanes_miles, policy_checks):
    """Universal color scale: Light red <$10M, Medium red $10-50M, Dark red >$50M"""
    styles = []

    base_style_template = {
        'marginBottom': '35px',
        'paddingBottom': '25px',
        'borderBottom': '2px solid #E8E8E8',
        'padding': '15px',
        'borderRadius': '4px',
        'transition': 'all 0.3s ease'
    }

    def get_color_for_cost(cost):
        """Universal thresholds for all spending"""
        if cost >= 50:
            return 'rgba(220, 38, 38, 0.12)'  # Dark red - $50M+
        elif cost >= 10:
            return 'rgba(220, 38, 38, 0.08)'  # Medium red - $10-50M
        elif cost > 0:
            return 'rgba(220, 38, 38, 0.04)'  # Light red - <$10M
        else:
            return 'transparent'

    # Child benefit
    base_style = base_style_template.copy()
    if child_age > 0 and child_amt > 0:
        num_children = CHILDREN_PER_AGE * (child_age + 1)
        annual_cost_per_child = child_amt * 12
        child_benefit_cost = (num_children * annual_cost_per_child) / 1000
        base_style['backgroundColor'] = get_color_for_cost(child_benefit_cost)
    else:
        base_style['backgroundColor'] = 'transparent'
    styles.append(base_style)

    # Baby bonus
    base_style = base_style_template.copy()
    baby_cost = (baby_bonus * BABIES_PER_YEAR) / 1_000_000
    base_style['backgroundColor'] = get_color_for_cost(baby_cost)
    styles.append(base_style)

    # Bike lanes
    base_style = base_style_template.copy()
    bike_cost = bike_lanes * BIKE_LANES_COST_PER_MILE
    base_style['backgroundColor'] = get_color_for_cost(bike_cost)
    styles.append(base_style)

    # Vacant rehab
    base_style = base_style_template.copy()
    vacant_cost = vacant_rehab * VACANT_HOME_REHAB_COST_PER_HOME
    base_style['backgroundColor'] = get_color_for_cost(vacant_cost)
    styles.append(base_style)

    # Public housing
    base_style = base_style_template.copy()
    housing_cost = public_housing * PUBLIC_HOUSING_COST_PER_UNIT
    base_style['backgroundColor'] = get_color_for_cost(housing_cost)
    styles.append(base_style)

    # Circulator headways
    base_style = base_style_template.copy()
    headways_cost = CIRCULATOR_HEADWAY_REDUCTION_EXISTING_COST if 'reduce' in circulator_headways else 0
    base_style['backgroundColor'] = get_color_for_cost(headways_cost)
    styles.append(base_style)

    # Circulator routes
    base_style = base_style_template.copy()
    if 'reduce' in circulator_headways:
        routes_cost = circulator_routes * CIRCULATOR_ROUTE_REDUCED_HEADWAY_COST
    else:
        routes_cost = circulator_routes * CIRCULATOR_ROUTE_BASE_COST
    base_style['backgroundColor'] = get_color_for_cost(routes_cost)
    styles.append(base_style)

    # Bus lanes
    base_style = base_style_template.copy()
    bus_cost = bus_lanes_miles * BUS_LANES_COST_PER_MILE
    base_style['backgroundColor'] = get_color_for_cost(bus_cost)
    styles.append(base_style)

    # Water taxi
    base_style = base_style_template.copy()
    water_cost = 0
    if 'water_taxi_free' in policy_checks:
        water_cost += WATER_TAXI_FREE_YEAR_ROUND
    if 'water_taxi_route' in policy_checks:
        water_cost += WATER_TAXI_ADDITIONAL_ROUTE
    base_style['backgroundColor'] = get_color_for_cost(water_cost)
    styles.append(base_style)

    return styles

# Create callbacks for all agency sliders
@app.callback(
    [Output(f'agency-display-{i}', 'children') for i in range(len(agencies))] +
    [Output('total-spending-change', 'children')],
    [Input(f'agency-slider-{i}', 'value') for i in range(len(agencies))] +
    [Input('homestead-slider', 'value'),
     Input('targeted-homeowners-checklist', 'value'),
     Input('child-benefit-age-slider', 'value'),
     Input('child-benefit-slider', 'value'),
     Input('baby-bonus-slider', 'value'),
     Input('bike-lanes-slider', 'value'),
     Input('vacant-rehab-slider', 'value'),
     Input('policy-checklist', 'value')]
)
def update_agency_spending(*all_values):
    agency_values = all_values[:len(agencies)]
    homestead_cap = all_values[len(agencies)]
    targeted_homeowners_checked = all_values[len(agencies) + 1]
    child_benefit_age = all_values[len(agencies) + 2]
    child_benefit_amount = all_values[len(agencies) + 3]
    baby_bonus_amount = all_values[len(agencies) + 4]
    bike_lanes_miles = all_values[len(agencies) + 5]
    vacant_rehab_homes = all_values[len(agencies) + 6]
    policy_checks = all_values[len(agencies) + 7]

    results = []
    total_change = 0

    # Agency changes
    for i, (agency, original_budget) in enumerate(agencies.items()):
        percent_change = agency_values[i]
        new_budget = original_budget * (1 + percent_change / 100)
        change = new_budget - original_budget
        total_change += change

        if percent_change > 0:
            color = '#DC2626'
            symbol = '+'
        elif percent_change < 0:
            color = '#16A34A'
            symbol = ''
        else:
            color = MDIPP_DARK_GRAY
            symbol = ''

        result = html.Div([
            html.Span(f'New: ${new_budget:.1f}M ', style={'color': MDIPP_DARK_GRAY}),
            html.Span(f'({symbol}{change:.1f}M)', style={'color': color})
        ])
        results.append(result)

    # Homestead credit savings (negative spending = savings)
    if homestead_cap <= CURRENT_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT
    elif homestead_cap >= MAX_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_10PCT
    else:
        pct_between = (homestead_cap - CURRENT_HOMESTEAD_CAP) / (MAX_HOMESTEAD_CAP - CURRENT_HOMESTEAD_CAP)
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT - (pct_between * (HOMESTEAD_COST_AT_4PCT - HOMESTEAD_COST_AT_10PCT))

    homestead_change = new_homestead_cost - HOMESTEAD_COST_AT_4PCT
    total_change += homestead_change

    # Targeted Homeowners Credit - if checked to eliminate, this is a savings (negative spending)
    if 'eliminate' in targeted_homeowners_checked:
        targeted_homeowners_change = -TARGETED_HOMEOWNERS_CREDIT_COST
    else:
        targeted_homeowners_change = 0
    total_change += targeted_homeowners_change

    # Other reforms
    # Child benefit: age determines number of kids (age + 1 because age 3 includes 0,1,2,3)
    if child_benefit_age > 0 and child_benefit_amount > 0:
        num_children = CHILDREN_PER_AGE * (child_benefit_age + 1)  # in thousands
        annual_cost_per_child = child_benefit_amount * 12  # monthly to annual
        child_benefit_cost = (num_children * annual_cost_per_child) / 1000  # convert to millions
    else:
        child_benefit_cost = 0

    baby_bonus_cost = (baby_bonus_amount * BABIES_PER_YEAR) / 1_000_000
    bike_lanes_cost = bike_lanes_miles * BIKE_LANES_COST_PER_MILE
    vacant_rehab_cost = vacant_rehab_homes * VACANT_HOME_REHAB_COST_PER_HOME

    total_change += child_benefit_cost
    total_change += baby_bonus_cost
    total_change += bike_lanes_cost
    total_change += vacant_rehab_cost

    if 'water_taxi' in policy_checks:
        total_change += WATER_TAXI_EXPANSION

    # Total spending change
    if total_change > 0:
        total_color = '#DC2626'
        total_symbol = '+'
    elif total_change < 0:
        total_color = '#16A34A'
        total_symbol = ''
    else:
        total_color = MDIPP_DARK_GRAY
        total_symbol = ''

    total_element = html.Span(f'{total_symbol}{format_currency(total_change)}', style={'color': total_color})
    results.append(total_element)

    return results

# Callback to toggle budget overview explanation
@app.callback(
    Output('budget-overview-explanation', 'style'),
    Input('budget-overview-info-icon', 'n_clicks'),
    State('budget-overview-explanation', 'style')
)
def toggle_budget_explanation(n_clicks, current_style):
    if n_clicks is None:
        raise PreventUpdate

    # Toggle display
    if current_style.get('display') == 'none':
        current_style['display'] = 'block'
    else:
        current_style['display'] = 'none'

    return current_style

# Callback to toggle revenue explanation
@app.callback(
    Output('revenue-explanation', 'style'),
    Input('revenue-info-icon', 'n_clicks'),
    State('revenue-explanation', 'style')
)
def toggle_revenue_explanation(n_clicks, current_style):
    if n_clicks is None:
        raise PreventUpdate

    # Toggle display
    if current_style.get('display') == 'none':
        current_style['display'] = 'block'
    else:
        current_style['display'] = 'none'

    return current_style

# Callback to toggle spending explanation
@app.callback(
    Output('spending-explanation', 'style'),
    Input('spending-info-icon', 'n_clicks'),
    State('spending-explanation', 'style')
)
def toggle_spending_explanation(n_clicks, current_style):
    if n_clicks is None:
        raise PreventUpdate

    # Toggle display
    if current_style.get('display') == 'none':
        current_style['display'] = 'block'
    else:
        current_style['display'] = 'none'

    return current_style

# Callback to toggle reforms explanation
@app.callback(
    Output('reforms-explanation', 'style'),
    Input('reforms-info-icon', 'n_clicks'),
    State('reforms-explanation', 'style')
)
def toggle_reforms_explanation(n_clicks, current_style):
    if n_clicks is None:
        raise PreventUpdate

    # Toggle display
    if current_style.get('display') == 'none':
        current_style['display'] = 'block'
    else:
        current_style['display'] = 'none'

    return current_style

# Callback to toggle meds & eds explanation
@app.callback(
    Output('meds-eds-explanation', 'style'),
    Input('meds-eds-info-icon', 'n_clicks'),
    State('meds-eds-explanation', 'style')
)
def toggle_meds_eds_explanation(n_clicks, current_style):
    if n_clicks is None:
        raise PreventUpdate

    # Toggle display
    if current_style.get('display') == 'none':
        current_style['display'] = 'block'
    else:
        current_style['display'] = 'none'

    return current_style

# Callback to toggle How to Use section
@app.callback(
    [Output('how-to-use-content', 'style'),
     Output('how-to-use-toggle-icon', 'children')],
    Input('how-to-use-header', 'n_clicks'),
    State('how-to-use-content', 'style')
)
def toggle_how_to_use(n_clicks, current_style):
    if n_clicks is None:
        raise PreventUpdate

    # Toggle display
    if current_style.get('display') == 'none':
        return {'display': 'block'}, '‚ñ≤'
    else:
        return {'display': 'none'}, '‚ñº'

# Homestead display callback
@app.callback(
    Output('homestead-display', 'children'),
    Input('homestead-slider', 'value')
)
def update_homestead_display(homestead_cap):
    if homestead_cap <= CURRENT_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT
    elif homestead_cap >= MAX_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_10PCT
    else:
        pct_between = (homestead_cap - CURRENT_HOMESTEAD_CAP) / (MAX_HOMESTEAD_CAP - CURRENT_HOMESTEAD_CAP)
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT - (pct_between * (HOMESTEAD_COST_AT_4PCT - HOMESTEAD_COST_AT_10PCT))

    change = new_homestead_cost - HOMESTEAD_COST_AT_4PCT

    if change < 0:
        color = '#16A34A'
        symbol = ''
    elif change > 0:
        color = '#DC2626'
        symbol = '+'
    else:
        color = MDIPP_DARK_GRAY
        symbol = ''

    return html.Div([
        html.Span(f'Cost: ${new_homestead_cost:.1f}M ', style={'color': MDIPP_DARK_GRAY}),
        html.Span(f'({symbol}${abs(change):.1f}M)', style={'color': color})
    ])

# Targeted Homeowners display callback
@app.callback(
    Output('targeted-homeowners-display', 'children'),
    Input('targeted-homeowners-checklist', 'value')
)
def update_targeted_homeowners_display(checked):
    if 'eliminate' in checked:
        return html.Div([
            html.Span(f'Cost: $0.0M ', style={'color': MDIPP_DARK_GRAY}),
            html.Span(f'(-${TARGETED_HOMEOWNERS_CREDIT_COST:.1f}M)', style={'color': '#16A34A'})
        ])
    else:
        return html.Div([
            html.Span(f'Cost: ${TARGETED_HOMEOWNERS_CREDIT_COST:.1f}M ', style={'color': MDIPP_DARK_GRAY}),
            html.Span('(no change)', style={'color': MDIPP_DARK_GRAY})
        ])

# Other reforms display callbacks
# Make meds & eds checkboxes mutually exclusive
@app.callback(
    Output('meds-eds-property-tax-checkbox', 'value', allow_duplicate=True),
    Input('meds-eds-services-checkbox', 'value'),
    State('meds-eds-property-tax-checkbox', 'value'),
    prevent_initial_call=True
)
def uncheck_property_tax_when_services_checked(services_checked, property_tax_checked):
    if 'services_cost' in services_checked and property_tax_checked:
        return []  # Uncheck property tax option
    return property_tax_checked

@app.callback(
    Output('meds-eds-services-checkbox', 'value', allow_duplicate=True),
    Input('meds-eds-property-tax-checkbox', 'value'),
    State('meds-eds-services-checkbox', 'value'),
    prevent_initial_call=True
)
def uncheck_services_when_property_tax_checked(property_tax_checked, services_checked):
    if 'full_tax' in property_tax_checked and services_checked:
        return []  # Uncheck services option
    return services_checked

@app.callback(
    Output('meds-eds-property-tax-display', 'children'),
    Input('meds-eds-property-tax-checkbox', 'value')
)
def update_meds_eds_property_tax_display(checked):
    if 'full_tax' in checked:
        net_revenue = MEDS_EDS_FULL_PROPERTY_TAX - MEDS_EDS_CURRENT_PILOT
        return f'Revenue: +{format_currency(net_revenue)}'
    return ''

@app.callback(
    Output('meds-eds-services-display', 'children'),
    Input('meds-eds-services-checkbox', 'value')
)
def update_meds_eds_services_display(checked):
    if 'services_cost' in checked:
        revenue_gain = MEDS_EDS_SERVICES_COST - MEDS_EDS_CURRENT_PILOT
        return f'Revenue: +{format_currency(revenue_gain)}'
    return ''

@app.callback(
    Output('child-benefit-display', 'children'),
    [Input('child-benefit-age-slider', 'value'),
     Input('child-benefit-slider', 'value')]
)
def update_child_benefit_display(age, amount):
    if age == 0 or amount == 0:
        return 'No benefit selected'

    num_children = CHILDREN_PER_AGE * (age + 1)  # in thousands
    annual_cost_per_child = amount * 12
    total_cost = (num_children * annual_cost_per_child) / 1000  # convert to millions

    return f'Annual cost: {format_currency(total_cost)} ({num_children:.0f}k children ages 0-{age})'

@app.callback(
    Output('baby-bonus-display', 'children'),
    Input('baby-bonus-slider', 'value')
)
def update_baby_bonus_display(amount):
    cost = (amount * BABIES_PER_YEAR) / 1_000_000
    if amount == 0:
        return 'No bonus selected'
    return f'Annual cost: {format_currency(cost)} ({BABIES_PER_YEAR:,} babies)'

@app.callback(
    Output('bike-lanes-display', 'children'),
    Input('bike-lanes-slider', 'value')
)
def update_bike_lanes_display(miles):
    cost = miles * BIKE_LANES_COST_PER_MILE
    if miles == 0:
        return 'No bike lanes selected'
    return f'Cost: {format_currency(cost)} ({miles} miles)'

@app.callback(
    Output('vacant-rehab-display', 'children'),
    Input('vacant-rehab-slider', 'value')
)
def update_vacant_rehab_display(homes):
    cost = homes * VACANT_HOME_REHAB_COST_PER_HOME
    if homes == 0:
        return 'No homes selected'
    return f'Annual cost: {format_currency(cost)} ({homes} homes)'

@app.callback(
    Output('public-housing-display', 'children'),
    Input('public-housing-slider', 'value')
)
def update_public_housing_display(units):
    cost = units * PUBLIC_HOUSING_COST_PER_UNIT
    if units == 0:
        return 'No units selected'
    return f'Cost: {format_currency(cost)} ({units} units)'

@app.callback(
    Output('circulator-headways-display', 'children'),
    Input('circulator-headways-checkbox', 'value')
)
def update_circulator_headways_display(checked):
    if 'reduce' in checked:
        return f'Annual cost: {format_currency(CIRCULATOR_HEADWAY_REDUCTION_EXISTING_COST)}'
    return 'No change selected'

@app.callback(
    Output('circulator-routes-display', 'children'),
    [Input('circulator-routes-slider', 'value'),
     Input('circulator-headways-checkbox', 'value')]
)
def update_circulator_routes_display(routes, headways_checked):
    if routes == 0:
        return 'No new routes selected'

    # Cost depends on whether headways are reduced
    if 'reduce' in headways_checked:
        cost_per_route = CIRCULATOR_ROUTE_REDUCED_HEADWAY_COST
        cost = routes * cost_per_route
        return f'Annual cost: {format_currency(cost)} ({routes} routes @ {format_currency(cost_per_route)} each with reduced headways)'
    else:
        cost_per_route = CIRCULATOR_ROUTE_BASE_COST
        cost = routes * cost_per_route
        return f'Annual cost: {format_currency(cost)} ({routes} routes @ {format_currency(cost_per_route)} each)'

@app.callback(
    Output('bus-lanes-new-display', 'children'),
    Input('bus-lanes-slider', 'value')
)
def update_bus_lanes_new_display(miles):
    cost = miles * BUS_LANES_COST_PER_MILE
    if miles == 0:
        return 'No bus lanes selected'
    return f'Cost: {format_currency(cost)} ({miles} miles)'

@app.callback(
    Output('reforms-total-cost', 'children'),
    [Input('child-benefit-age-slider', 'value'),
     Input('child-benefit-slider', 'value'),
     Input('baby-bonus-slider', 'value'),
     Input('bike-lanes-slider', 'value'),
     Input('vacant-rehab-slider', 'value'),
     Input('public-housing-slider', 'value'),
     Input('circulator-headways-checkbox', 'value'),
     Input('circulator-routes-slider', 'value'),
     Input('bus-lanes-slider', 'value'),
     Input('policy-checklist', 'value')]
)
def update_reforms_total(child_benefit_age, child_benefit_amount, baby_bonus, bike_lanes, vacant_rehab_homes,
                        public_housing_units, circulator_headways, circulator_routes, bus_lanes_miles, policy_checks):
    total = 0

    # Child benefit calculation
    if child_benefit_age > 0 and child_benefit_amount > 0:
        num_children = CHILDREN_PER_AGE * (child_benefit_age + 1)  # in thousands
        annual_cost_per_child = child_benefit_amount * 12
        child_benefit_cost = (num_children * annual_cost_per_child) / 1000  # convert to millions
        total += child_benefit_cost

    total += (baby_bonus * BABIES_PER_YEAR) / 1_000_000
    total += bike_lanes * BIKE_LANES_COST_PER_MILE
    total += vacant_rehab_homes * VACANT_HOME_REHAB_COST_PER_HOME
    total += public_housing_units * PUBLIC_HOUSING_COST_PER_UNIT

    # Transit improvements
    if 'reduce' in circulator_headways:
        total += CIRCULATOR_HEADWAY_REDUCTION_EXISTING_COST
        # New routes with reduced headways cost more
        total += circulator_routes * CIRCULATOR_ROUTE_REDUCED_HEADWAY_COST
    else:
        # New routes without reduced headways
        total += circulator_routes * CIRCULATOR_ROUTE_BASE_COST

    total += bus_lanes_miles * BUS_LANES_COST_PER_MILE

    if 'water_taxi_free' in policy_checks:
        total += WATER_TAXI_FREE_YEAR_ROUND
    if 'water_taxi_route' in policy_checks:
        total += WATER_TAXI_ADDITIONAL_ROUTE

    return f'{format_currency(total)}/year'

# Revenue callbacks including net balance banner
@app.callback(
    [Output('property-tax-revenue-display', 'children'),
     Output('income-tax-revenue-display', 'children'),
     Output('energy-tax-revenue-display', 'children'),
     Output('total-revenue-change-display', 'children'),
     Output('net-balance-banner', 'children')],
    [Input('property-tax-slider', 'value'),
     Input('income-tax-slider', 'value'),
     Input('energy-tax-slider', 'value')] +
    [Input(f'agency-slider-{i}', 'value') for i in range(len(agencies))] +
    [Input('homestead-slider', 'value'),
     Input('targeted-homeowners-checklist', 'value'),
     Input('meds-eds-property-tax-checkbox', 'value'),
     Input('meds-eds-services-checkbox', 'value'),
     Input('child-benefit-age-slider', 'value'),
     Input('child-benefit-slider', 'value'),
     Input('baby-bonus-slider', 'value'),
     Input('bike-lanes-slider', 'value'),
     Input('vacant-rehab-slider', 'value'),
     Input('public-housing-slider', 'value'),
     Input('circulator-headways-checkbox', 'value'),
     Input('circulator-routes-slider', 'value'),
     Input('bus-lanes-slider', 'value'),
     Input('policy-checklist', 'value')]
)
def update_all(*all_values):
    property_rate = all_values[0]
    income_rate = all_values[1]
    energy_tax_percent = all_values[2]
    agency_values = all_values[3:3+len(agencies)]
    homestead_cap = all_values[3+len(agencies)]
    targeted_homeowners_checked = all_values[4+len(agencies)]
    meds_eds_property_tax_checked = all_values[5+len(agencies)]
    meds_eds_services_checked = all_values[6+len(agencies)]
    child_benefit_age = all_values[7+len(agencies)]
    child_benefit_amount = all_values[8+len(agencies)]
    baby_bonus_amount = all_values[9+len(agencies)]
    bike_lanes_miles = all_values[10+len(agencies)]
    vacant_rehab_homes = all_values[11+len(agencies)]
    public_housing_units = all_values[12+len(agencies)]
    circulator_headways = all_values[13+len(agencies)]
    circulator_routes = all_values[14+len(agencies)]
    bus_lanes_miles_new = all_values[15+len(agencies)]
    policy_checks = all_values[16+len(agencies)]

    # Property tax calculations
    property_multiplier = property_rate / CURRENT_PROPERTY_TAX_RATE
    new_property_revenue = PROPERTY_TAX_REVENUE * property_multiplier
    property_change = new_property_revenue - PROPERTY_TAX_REVENUE

    # Income tax calculations
    income_multiplier = income_rate / CURRENT_INCOME_TAX_RATE
    new_income_revenue = INCOME_TAX_REVENUE * income_multiplier
    income_change = new_income_revenue - INCOME_TAX_REVENUE

    # Energy tax calculations
    energy_multiplier = 1 + (energy_tax_percent / 100)
    new_energy_revenue = CURRENT_ENERGY_TAX_REVENUE * energy_multiplier
    energy_change = new_energy_revenue - CURRENT_ENERGY_TAX_REVENUE

    # Meds & Eds revenue
    meds_eds_revenue_change = 0
    if 'full_tax' in meds_eds_property_tax_checked:
        # Net revenue gain = full property tax minus current PILOT payment
        meds_eds_revenue_change += (MEDS_EDS_FULL_PROPERTY_TAX - MEDS_EDS_CURRENT_PILOT)
    if 'services_cost' in meds_eds_services_checked:
        meds_eds_revenue_change += (MEDS_EDS_SERVICES_COST - MEDS_EDS_CURRENT_PILOT)

    # Total revenue change
    total_revenue_change = property_change + income_change + energy_change + meds_eds_revenue_change

    # Calculate total spending change
    total_spending_change = 0

    # Agency changes
    for i, (agency, original_budget) in enumerate(agencies.items()):
        percent_change = agency_values[i]
        change = original_budget * (percent_change / 100)
        total_spending_change += change

    # Homestead credit
    if homestead_cap <= CURRENT_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT
    elif homestead_cap >= MAX_HOMESTEAD_CAP:
        new_homestead_cost = HOMESTEAD_COST_AT_10PCT
    else:
        pct_between = (homestead_cap - CURRENT_HOMESTEAD_CAP) / (MAX_HOMESTEAD_CAP - CURRENT_HOMESTEAD_CAP)
        new_homestead_cost = HOMESTEAD_COST_AT_4PCT - (pct_between * (HOMESTEAD_COST_AT_4PCT - HOMESTEAD_COST_AT_10PCT))

    homestead_change = new_homestead_cost - HOMESTEAD_COST_AT_4PCT
    total_spending_change += homestead_change

    # Targeted Homeowners Credit - if checked to eliminate, this is a savings (negative spending)
    if 'eliminate' in targeted_homeowners_checked:
        targeted_homeowners_change = -TARGETED_HOMEOWNERS_CREDIT_COST
    else:
        targeted_homeowners_change = 0
    total_spending_change += targeted_homeowners_change

    # Other reforms
    # Child benefit calculation
    if child_benefit_age > 0 and child_benefit_amount > 0:
        num_children = CHILDREN_PER_AGE * (child_benefit_age + 1)  # in thousands
        annual_cost_per_child = child_benefit_amount * 12
        child_benefit_cost = (num_children * annual_cost_per_child) / 1000  # convert to millions
    else:
        child_benefit_cost = 0

    baby_bonus_cost = (baby_bonus_amount * BABIES_PER_YEAR) / 1_000_000
    bike_lanes_cost = bike_lanes_miles * BIKE_LANES_COST_PER_MILE
    vacant_rehab_cost = vacant_rehab_homes * VACANT_HOME_REHAB_COST_PER_HOME
    public_housing_cost = public_housing_units * PUBLIC_HOUSING_COST_PER_UNIT

    # Transit improvements
    circulator_headways_cost = CIRCULATOR_HEADWAY_REDUCTION_EXISTING_COST if 'reduce' in circulator_headways else 0
    if 'reduce' in circulator_headways:
        circulator_new_routes_cost = circulator_routes * CIRCULATOR_ROUTE_REDUCED_HEADWAY_COST
    else:
        circulator_new_routes_cost = circulator_routes * CIRCULATOR_ROUTE_BASE_COST
    bus_lanes_cost = bus_lanes_miles_new * BUS_LANES_COST_PER_MILE

    total_spending_change += child_benefit_cost
    total_spending_change += baby_bonus_cost
    total_spending_change += bike_lanes_cost
    total_spending_change += vacant_rehab_cost
    total_spending_change += public_housing_cost
    total_spending_change += circulator_headways_cost
    total_spending_change += circulator_new_routes_cost
    total_spending_change += bus_lanes_cost

    if 'water_taxi_free' in policy_checks:
        total_spending_change += WATER_TAXI_FREE_YEAR_ROUND
    if 'water_taxi_route' in policy_checks:
        total_spending_change += WATER_TAXI_ADDITIONAL_ROUTE

    # Calculate net balance
    net_balance = total_revenue_change - total_spending_change

    # Color code changes helper function
    def format_change_text(change):
        if change > 0:
            return f'+{format_currency(change)}', '#16A34A'
        elif change < 0:
            return f'{format_currency(change)}', '#DC2626'
        else:
            return f'{format_currency(change)}', MDIPP_DARK_GRAY

    # Format inline displays like agency sliders
    property_change_text, property_color = format_change_text(property_change)
    property_display = html.Div([
        html.Span(f'Revenue: {format_currency(new_property_revenue)} ', style={'color': MDIPP_DARK_GRAY}),
        html.Span(f'({property_change_text})', style={'color': property_color})
    ])

    income_change_text, income_color = format_change_text(income_change)
    income_display = html.Div([
        html.Span(f'Revenue: {format_currency(new_income_revenue)} ', style={'color': MDIPP_DARK_GRAY}),
        html.Span(f'({income_change_text})', style={'color': income_color})
    ])

    energy_change_text, energy_color = format_change_text(energy_change)
    energy_display = html.Div([
        html.Span(f'Revenue: {format_currency(new_energy_revenue)} ', style={'color': MDIPP_DARK_GRAY}),
        html.Span(f'({energy_change_text})', style={'color': energy_color})
    ])

    total_revenue_change_text, total_revenue_color = format_change_text(total_revenue_change)
    total_revenue_display = html.Span(total_revenue_change_text, style={'color': total_revenue_color})

    # Net Balance Banner
    if net_balance > 0:
        balance_color = '#16A34A'
        balance_label = 'Budget Surplus'
        balance_symbol = '+'
        balance_icon = '‚úì'
    elif net_balance < 0:
        balance_color = '#DC2626'
        balance_label = 'Budget Deficit'
        balance_symbol = ''
        balance_icon = '‚ö†'
    else:
        balance_color = MDIPP_MAROON
        balance_label = 'Balanced Budget'
        balance_symbol = ''
        balance_icon = '='

    net_balance_banner = html.Div([
        html.Div(style={'display': 'inline-block', 'marginRight': '20px'}, children=[
            html.Span(balance_icon, className='balance-icon-mobile', style={'fontSize': '36px', 'color': balance_color, 'marginRight': '10px'}),
        ]),
        html.Div(style={'display': 'inline-block', 'textAlign': 'left'}, children=[
            html.Div(balance_label, style={'fontSize': '18px', 'color': '#666', 'marginBottom': '5px', 'textTransform': 'uppercase', 'letterSpacing': '1px'}),
            html.Div(f'{balance_symbol}{format_currency(abs(net_balance))}', className='balance-banner-mobile', style={'fontSize': '42px', 'fontWeight': 'bold', 'color': balance_color}),
        ])
    ])

    return (property_display, income_display, energy_display,
            total_revenue_display, net_balance_banner)

if __name__ == '__main__':
    app.run(debug=True, port=8050)